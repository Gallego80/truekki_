<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Crear Subasta - TRUEKKI</title>
    <link rel="stylesheet" href="../css/subastas.css" />
</head>
<body>
    <!-- HEADER TRUEKKI -->
    <header class="main-header">
        <div class="logo">TRUEKKI</div>
        <div class="search-bar">
            <input type="text" placeholder="Buscar productos..." />
            <button class="btn-search">üîç</button>
        </div>
        <div class="icons">
            <span class="icon menu-btn" onclick="openMenu()">‚ò∞</span>
        </div>
    </header>

    <div class="container">
        <h2>Crear nueva subasta</h2>

        <form id="formSubasta">
            <div class="form-group">
                <label for="producto">Producto</label>
                <select id="producto" name="producto" required>
                    <option value="">Selecciona un producto...</option>
                </select>
            </div>

            <div class="form-group">
                <label>Precio inicial</label>
                <input type="number" id="precio" placeholder="Ej: 50000" required />
            </div>

            <button class="btn" type="submit">Publicar subasta</button>
        </form>
    </div>

    <!-- Men√∫ lateral -->
    <div class="sidebar" id="sidebar">
        <span class="close-btn" onclick="closeMenu()">‚úñ</span>
        <div class="user-info">
            <div class="user-avatar" id="sidebar-avatar">US</div>
            <div class="user-name" id="sidebar-name">Usuario</div>
        </div>
        <a href="barra.html">Inicio</a>
        <a href="publicar_producto.html">Publicar</a>
        <a href="#">Notificaciones</a>
        <a href="chat.html">Chats</a>
        <a href="historial.html">Historial</a>
        <a href="perfil.html">Perfil</a>
        <a href="#">Ayuda</a>
        <a href="favoritos.html">Mis Favoritos</a>

        <button onclick="logout()" class="cerrar-sesion">Cerrar Sesi√≥n</button>
    </div>

    <div class="overlay" id="overlay" onclick="closeMenu()"></div>

<script type="module">

// Funciones men√∫
window.openMenu = function () {
    document.getElementById("sidebar").style.width = "280px";
    document.getElementById("overlay").style.display = "block";
};
window.closeMenu = function () {
    document.getElementById("sidebar").style.width = "0";
    document.getElementById("overlay").style.display = "none";
};

// Cargar productos del usuario en el select
async function cargarProductos() {
    const select = document.getElementById("producto");
    select.innerHTML = `<option>Cargando...</option>`;

    const usuario = JSON.parse(localStorage.getItem("usuario"));
    if (!usuario) {
        select.innerHTML = `<option>No hay usuario logueado</option>`;
        return;
    }

    const userId = usuario.id;

    try {
        const response = await fetch(`http://localhost:5000/productos-usuario/${userId}`);
        const data = await response.json();

        if (!data.success || data.productos.length === 0) {
            select.innerHTML = `<option>No tienes productos publicados</option>`;
            return;
        }

        select.innerHTML = "";
        data.productos.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.id_producto;
            opt.textContent = p.titulo || "(Sin t√≠tulo)";
            select.appendChild(opt);
        });

    } catch (error) {
        console.error("ERROR FETCH:", error);
        select.innerHTML = `<option>Error al cargar productos</option>`;
    }
}

// Publicar subasta
document.getElementById("formSubasta").addEventListener("submit", async (e) => {
    e.preventDefault();

    const usuario = JSON.parse(localStorage.getItem("usuario"));
    if (!usuario) {
        alert("Debes iniciar sesi√≥n para publicar una subasta.");
        return;
    }

    const id_usuario = usuario.id;
    const id_producto = document.getElementById("producto").value;
    const monto = document.getElementById("precio").value;

    if (!id_producto || !monto) {
        alert("Completa todos los campos.");
        return;
    }

    try {
        const response = await fetch("http://localhost:5000/publicar-subasta", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id_usuario, id_producto, precio_inicial: monto })
        });
        const data = await response.json();

        if (data.success) {
            alert("Subasta publicada con √©xito.");
            window.location.href = "lista_subastas.html";
        } else {
            alert("Error: " + data.message);
        }
    } catch (error) {
        console.error("ERROR al publicar subasta:", error);
        alert("Error en la conexi√≥n con el servidor.");
    }
});

document.addEventListener("DOMContentLoaded", cargarProductos);

</script>
</body>
</html>
