<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TRUEKKI - Crear Subasta</title>

  <!-- Tu estilo general -->
  <link rel="stylesheet" href="../estilos/barra.css" />
  <link rel="stylesheet" href="/css/subasta.css">
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
</head>

<body>
  <!-- üîµ Barra superior -->
  <header>
    <div class="header-content">
      <h1>TRUEKKI</h1>

      <div class="search-bar">
        <input type="text" placeholder="Buscar..." />
        <button><i class="fas fa-search"></i></button>
      </div>

      <div class="icons">
        <span class="icon menu-btn" onclick="openMenu()">
          <i class="fas fa-bars"></i>
        </span>
      </div>
    </div>
  </header>

  <!-- üîµ Men√∫ lateral -->
  <div class="sidebar" id="sidebar">
    <span class="close-btn" onclick="closeMenu()">‚úñ</span>

    <div class="user-info">
      <div class="user-avatar" id="sidebar-avatar">US</div>
      <div class="user-name" id="sidebar-name">Usuario</div>
    </div>

    <a href="publicar_producto.html"><i class="fas fa-plus-circle"></i> Publicar</a>
    <a href="chat.html"><i class="fas fa-comments"></i> Chats</a>
    <a href="subastas.html"><i class="fas fa-gavel"></i> Subastas</a>
    <a href="lista-subasta.html"><i class="fas fa-list"></i> Lista de Subastas</a>

    <button onclick="logout()" class="cerrar-sesion">
      <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
    </button>
  </div>

  <!-- Overlay -->
  <div class="overlay" id="overlay" onclick="closeMenu()"></div>

  <!-- ‚≠ê CONTENIDO PRINCIPAL -->
  <div class="container">
    <div class="form-container">
      <h2>üî® Crear Nueva Subasta</h2>

      <form id="formSubasta" enctype="multipart/form-data">
        <div class="form-group">
          <label>T√≠tulo de la Subasta *</label>
          <input type="text" name="titulo" required placeholder="Ej: Televisor Samsung 40 pulgadas" />
        </div>

        <div class="form-group">
          <label>Descripci√≥n *</label>
          <textarea name="descripcion" required placeholder="Describe las condiciones del producto"></textarea>
        </div>

        <div class="form-group">
          <label>Precio Inicial ($) *</label>
          <input type="number" name="precio_inicial" required min="1" placeholder="Ej: 150000" />
        </div>

        <div class="form-group">
          <label>Duraci√≥n de la Subasta *</label>
          <select name="duracion_horas" required>
            <option value="">Selecciona duraci√≥n</option>
            <option value="1">1 hora</option>
            <option value="3">3 horas</option>
            <option value="6">6 horas</option>
            <option value="12">12 horas</option>
            <option value="24">24 horas (1 d√≠a)</option>
            <option value="48">48 horas (2 d√≠as)</option>
            <option value="72">72 horas (3 d√≠as)</option>
            <option value="168">7 d√≠as</option>
          </select>
        </div>

        <div class="form-group">
          <label>Imagen del Producto *</label>
          <input type="file" name="foto" accept="image/*" required onchange="mostrarVistaPrevia(event)" />
          <img id="vistaPrevia" class="preview-img" alt="Vista previa de la imagen"/>
        </div>

        <button type="submit" class="submit-btn" id="btnSubmit">Publicar Subasta</button>
      </form>
    </div>
  </div>

  <!-- FOOTER -->
  <footer>
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h3>TRUEKKI</h3>
          <p>Plataforma de intercambios y ventas.</p>
        </div>
      </div>

      <div class="copyright">
        &copy; 2024 TRUEKKI - Todos los derechos reservados
      </div>
    </div>
  </footer>

  <script>
    /* ==========================
       FUNCI√ìN LOGOUT
    =========================== */
    function logout() {
      localStorage.removeItem('usuario');
      localStorage.removeItem('isLoggedIn');
      window.location.href = 'login.html';
    }

    /* ==========================
       VERIFICAR AUTENTICACI√ìN
    =========================== */
    function checkAuth() {
      const usuario = localStorage.getItem('usuario');
      if (!usuario) {
        alert('Debes iniciar sesi√≥n para crear una subasta');
        window.location.href = 'login.html';
        return false;
      }
      return true;
    }

    // Verificar al cargar
    if (!checkAuth()) {
      // Ya redirige
    }

    /* ==========================
       CARGAR INFO USUARIO
    =========================== */
    function cargarInfoUsuario() {
      const usuarioStr = localStorage.getItem('usuario');
      if (usuarioStr) {
        try {
          const usuario = JSON.parse(usuarioStr);
          if (usuario.nombre) {
            document.getElementById('sidebar-name').textContent = usuario.nombre;
            
            const iniciales = usuario.nombre.split(' ')
              .map(n => n[0])
              .join('')
              .toUpperCase()
              .substring(0, 2);
            document.getElementById('sidebar-avatar').textContent = iniciales;
          }
        } catch (e) {
          console.error('Error parseando usuario:', e);
        }
      }
    }

    cargarInfoUsuario();

    /* ==========================
           MEN√ö
    =========================== */
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");

    function openMenu() {
      sidebar.style.width = "280px";
      overlay.style.display = "block";
    }

    function closeMenu() {
      sidebar.style.width = "0";
      overlay.style.display = "none";
    }

    /* ==========================
        Vista previa imagen
    =========================== */
    function mostrarVistaPrevia(event) {
      const img = document.getElementById("vistaPrevia");
      const file = event.target.files[0];
      
      if (file) {
        // Validar tama√±o m√°ximo 5MB
        if (file.size > 5 * 1024 * 1024) {
          alert('La imagen es muy grande. M√°ximo 5MB');
          event.target.value = '';
          return;
        }
        
        // Validar tipo
        if (!file.type.startsWith('image/')) {
          alert('Solo se permiten im√°genes');
          event.target.value = '';
          return;
        }
        
        img.src = URL.createObjectURL(file);
        img.style.display = "block";
      }
    }

    /* ==========================
          ENVIAR SUBASTA
    =========================== */
    document.getElementById("formSubasta").addEventListener("submit", async (e) => {
      e.preventDefault();

      console.log("üì§ Iniciando env√≠o de subasta...");

      // ‚úÖ OBTENER ID USUARIO CORRECTAMENTE
      const usuarioStr = localStorage.getItem("usuario");

      if (!usuarioStr) {
        alert("Error: No se encontr√≥ el ID de usuario. Inicia sesi√≥n nuevamente.");
        window.location.href = 'login.html';
        return;
      }

      let idUsuario;
      try {
        const usuario = JSON.parse(usuarioStr);
        idUsuario = usuario.id || usuario.id_usuario;
        
        if (!idUsuario) {
          throw new Error('ID de usuario no encontrado');
        }
        
        console.log("‚úÖ ID Usuario:", idUsuario);
      } catch (error) {
        console.error("‚ùå Error parseando usuario:", error);
        alert("Error con la sesi√≥n. Inicia sesi√≥n nuevamente.");
        window.location.href = 'login.html';
        return;
      }

      // Deshabilitar bot√≥n
      const btnSubmit = document.getElementById('btnSubmit');
      btnSubmit.disabled = true;
      btnSubmit.textContent = 'Publicando...';

      const formData = new FormData(e.target);
      formData.append("id_usuario", idUsuario);

      // Log de datos
      console.log("üìã Datos a enviar:");
      for (let [key, value] of formData.entries()) {
        if (key !== 'foto') {
          console.log(`  ${key}: ${value}`);
        } else {
          console.log(`  foto: ${value.name} (${value.size} bytes)`);
        }
      }

      try {
        // ‚úÖ CORREGIDO: Una sola barra diagonal
        console.log("üåê Enviando a: http://localhost:5000/crear-subasta");
        
        const res = await fetch("http://localhost:5000/crear-subasta", {
          method: "POST",
          body: formData
        });

        console.log("üì° Status recibido:", res.status);

        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }

        const data = await res.json();
        console.log("üì¶ Respuesta:", data);

        if (data.success) {
          alert("‚úÖ Subasta publicada exitosamente üéâ");
          window.location.href = "lista-subasta.html";
        } else {
          alert("‚ùå Error: " + (data.message || 'Error desconocido'));
          btnSubmit.disabled = false;
          btnSubmit.textContent = 'Publicar Subasta';
        }
      } catch (err) {
        console.error("‚ùå Error completo:", err);
        alert("Error al conectar con el servidor. Verifica:\n1. Que el servidor est√© corriendo\n2. Que la URL sea correcta");
        btnSubmit.disabled = false;
        btnSubmit.textContent = 'Publicar Subasta';
      }
    });
  </script>
</body>
</html>